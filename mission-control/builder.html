<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EDIT DASHBOARD</title>
    <script>
        let root = document.documentElement;
        var lastTheme = window.localStorage.getItem("theme") || "light";

        if (lastTheme == "dark") {
            window.localStorage.setItem("theme", "dark")

            root.style.setProperty("--appInner", "black")
            root.style.setProperty("--title", "white")
            root.style.setProperty("--navLink", "white")
            root.style.setProperty("--sidebar", "rgb(49, 49, 49)")
            root.style.setProperty("--cmds", "white")
            root.style.setProperty("--widBorder", "#2a2a2a")
            root.style.setProperty("--tabsclr", "white")
            root.style.setProperty("--thm-wid", "#151515")
        } else {
            window.localStorage.setItem("theme", "light")

            root.style.setProperty("--appInner", "white")
            root.style.setProperty("--title", "black")
            root.style.setProperty("--navLink", "rgb(103, 111, 128)")
            root.style.setProperty("--sidebar", "rgb(243, 245, 249)")
            root.style.setProperty("--cmds", "black")
            root.style.setProperty("--widBorder", "#d2d2d2")
            root.style.setProperty("--tabsclr", "black")
            root.style.setProperty("--thm-wid", "white")

        }
    </script>
    <link rel="icon" type="image/png" href="http://192.168.31.249/logo.png">
    <style>
        .no-js #loader {
            display: none;
        }

        .js #loader {
            display: block;
            position: absolute;
            left: 100px;
            top: 0;
        }

        .se-pre-con {
            position: fixed;
            left: 0px;
            top: 0px;
            width: 100%;
            height: 100%;
            z-index: 9999;
            background: url(http://192.168.31.249/IOTINE_V2/mission-control/332.gif) center no-repeat #fff;
        }
    </style>
    <link rel="stylesheet" href="http://192.168.31.249/IOTINE_V2/mission-control/style.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.9.0/jquery.min.js"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <script src="http://192.168.31.249/analDash/chart.js" type="text/javascript"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/modernizr/2.8.3/modernizr.js"></script>
    <script>
        $(window).load(function () {
            // Animate loader off screen
            $(".se-pre-con").fadeOut("slow");
        });
    </script>
</head>

<body>
    <div class="se-pre-con"></div>
    <div class="sidebar">
        <div class="inner">
            <div class="main-panel">
                <button
                    onclick="window.location.replace('http://192.168.31.249:3002/'+window.location.pathname.split('/')[2]+'/'+window.location.pathname.split('/')[3])"><img
                        title="IOTINE" src="http://192.168.31.249/IOTINE_V2/mission-control/logo.png" alt=""></button>
            </div>
            <div class="bottom-panel">
                <button><i class="material-icons">settings</i></button>
                <button onclick="toggleDis('.side-settings')"><img
                        src="https://secure.gravatar.com/avatar/12c5d52b156cff381bbe700f159d237b?s=96&amp;d=https%3A%2F%2Fpro-icons-avatars.s3.amazonaws.com%2Fimg%2Fd2.png"
                        alt=""></button>
            </div>
        </div>
    </div>
    <div class="side-settings settings" style="display: none;">
        <button>Settings</button>
        <button>More</button>
        <button>Fake</button>
    </div>
    <div id="app">
        <div class="sc-gleUXh jZiiGj">
            <div class="header-notification" style="height: auto; display: block; background-color: rgb(255, 203, 44);">
                <div class="notification-container">
                    <div class="notification-text">
                        <p class="notification-info" style="color: rgb(73, 51, 0); text-shadow: none;">Edit Dashboard
                        </p>
                    </div>
                    <div class="notification-action"><button
                            onclick="window.location.replace('http://192.168.31.249:3000/'+window.location.pathname.split('/')[2]+'/'+window.location.pathname.split('/')[3])"
                            class=" dash-color-primary dash-size-regular sc-gzVnrw cqGrfU"
                            style="color: rgb(73, 51, 0);"><span>Done</span></button><img class="close-btn" src=""
                            style="display: none;">
                    </div>
                </div>
            </div>
        </div>
        <div class="sc-gtfDJT diMILA" style="display:block;">
            <div class="sc-jMMfwr lhmKww">
                <div class=" dash-size-regular sc-kGXeez fkEHRF">
                    <div class="sc-kpOJdX iQYOlv">
                        <div class="title-text sc-chPdSV jgeneq">Widgets</div>
                        <div class="sub-text sc-kgoBCf cTHQrV"></div>
                    </div>
                </div>
            </div>
            <div class="sc-fOICqy eEQKgH">
                <div class="sc-jtRlXQ dPoHcy">
                    <ul>
                        <label class="wid-seps" for="">CHARTS</label><br>
                        <li class="sc-bEjcJn joFqRi">
                            <div data-wtype="chart" class="sc-ePZHVD ePRQm"><a data-wtype="chart" aria-current="page"
                                    class="navlink " href="#" onclick="">
                                    <div>Line Chart</div>
                                </a>
                            </div>
                        </li>
                        <li class="sc-bEjcJn joFqRi">
                            <div class="sc-ePZHVD ePRQm"><a data-wtype="chart" aria-current="page" class="navlink "
                                    href="#" onclick="">
                                    <div>Bar Chart</div>
                                </a>
                            </div>
                        </li>
                        <li class="sc-bEjcJn joFqRi">
                            <div data-wtype="chart" class="sc-ePZHVD ePRQm"><a data-wtype="chart" aria-current="page"
                                    class="navlink " href="#" onclick="">
                                    <div>Pie Chart</div>
                                </a>
                            </div>
                        </li>
                        <label class="wid-seps" for="">BUTTONS</label><br>
                        <li class="sc-bEjcJn joFqRi">
                            <div class="sc-ePZHVD ePRQm"><a data-wtype="btn" aria-current="page" class="navlink "
                                    href="#" onclick="">
                                    <div>ON / OFF</div>
                                </a>
                            </div>
                        </li>
                        <label class="wid-seps" for="">MAPS</label><br>
                        <li class="sc-bEjcJn joFqRi">
                            <div data-wtype="maps" class="sc-ePZHVD ePRQm"><a data-wtype="map" aria-current="page"
                                    class="navlink " href="#" onclick="">
                                    <div>Google Maps</div>
                                </a>
                            </div>
                        </li>
                        <label class="wid-seps" for="">SLIDERS</label><br>
                        <li class="sc-bEjcJn joFqRi">
                            <div data-wtype="range" class="sc-ePZHVD ePRQm"><a data-wtype="range" aria-current="page"
                                    class="navlink " href="#" onclick="">
                                    <div>Range Sliders</div>
                                </a>
                            </div>
                        </li>
                        <li class="sc-bEjcJn joFqRi">
                            <div data-wtype="range" class="sc-ePZHVD ePRQm"><a aria-current="page" class="navlink "
                                    href="#" onclick="">
                                    <div>Progress Bars</div>
                                </a>
                            </div>
                        </li>
                        <label class="wid-seps" for="">MISCELLANEOUS</label><br>
                        <li class="sc-bEjcJn joFqRi">
                            <div data-wtype="log" class="sc-ePZHVD ePRQm"><a data-wtype="log" aria-current="page"
                                    class="navlink " href="#" onclick="">
                                    <div>Data Log</div>
                                </a>
                            </div>
                        </li>
                        <li class="sc-bEjcJn joFqRi">
                            <div data-wtype="img" class="sc-ePZHVD ePRQm"><a data-wtype="img"" aria-current=" page"
                                    class="navlink " href="#" onclick="">
                                    <div>Image</div>
                                </a>
                            </div>
                        </li>
                        <li class="sc-bEjcJn joFqRi">
                            <div data-wtype="vid" class="sc-ePZHVD ePRQm"><a data-wtype="vid" aria-current="page"
                                    class="navlink " href="#" onclick="">
                                    <div>Video</div>
                                </a>
                            </div>
                        </li>
                        <li class="sc-bEjcJn joFqRi">
                            <div data-wtype="iframe" class="sc-ePZHVD ePRQm"><a data-wtype="iframe" aria-current="page"
                                    class="navlink " href="#" onclick="">
                                    <div>IFrame</div>
                                </a>
                            </div>
                        </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="sc-gtfDJT diMILA propane" style="display:none;">
            <div class="sc-jMMfwr lhmKww">
                <div class=" dash-size-regular sc-kGXeez fkEHRF">
                    <div class="sc-kpOJdX iQYOlv">
                        <div class="title-text sc-chPdSV jgeneq">Properties - </div>
                        <div class="sub-text sc-kgoBCf cTHQrV"></div>
                    </div>
                </div>
            </div>
            <div class="sc-fOICqy eEQKgH">
                <div class="sc-jtRlXQ dPoHcy">
                    <ul>
                        <li class="sc-bEjcJn joFqRi">
                            <div class="sc-ePZHVD ePRQm">
                                <label for="">Name : </label>
                                <input id="name" type="text">
                            </div>
                        </li>
                        <li class="sc-bEjcJn joFqRi">
                            <div class="sc-ePZHVD ePRQm" style="display:block !important;">
                                <label for="">Device : </label>
                                <select onchange="loadFeeds(this.value)" id="devProp" style="width:90% !important;">
                                    <option value="0">Select your device</option>
                                </select>
                            </div>
                        </li>
                        <li class="sc-bEjcJn joFqRi">
                            <div class="sc-ePZHVD ePRQm" style="display:block !important;">
                                <label for="">Feed : </label>
                                <select id="devFeeds" style="width:90% !important;">
                                    <option value="0">Select device feed</option>
                                </select>
                            </div>
                        </li>
                        <div class="chartcnt" style="display: none;">
                            <li class="sc-bEjcJn joFqRi">
                                <div class="sc-ePZHVD ePRQm">
                                    <label for="">Backgr<br>ound Color : </label>
                                    <input id="bgc" type="text">
                                </div>
                            </li>
                            <li class="sc-bEjcJn joFqRi">
                                <div class="sc-ePZHVD ePRQm">
                                    <label for="">Border Color : </label>
                                    <input id="brdc" type="text">
                                </div>
                            </li>
                            <li class="sc-bEjcJn joFqRi">
                                <div class="sc-ePZHVD ePRQm">
                                    <label for="">Border Width : </label>
                                    <input id="brdw" type="text">
                                </div>
                            </li>
                        </div>
                        <div class="btncnt" style="display: none;">

                        </div>
                        <div class="mapcnt" style="display: none;">

                        </div>
                        <div class="rangecnt" style="display: none;">
                            <li class="sc-bEjcJn joFqRi">
                                <div class="sc-ePZHVD ePRQm">
                                    <label for="">Min Value : </label>
                                    <input id="minval" type="text">
                                </div>
                            </li>
                            <li class="sc-bEjcJn joFqRi">
                                <div class="sc-ePZHVD ePRQm">
                                    <label for="">Max Val : </label>
                                    <input id="maxval" type="text">
                                </div>
                            </li>
                            <li class="sc-bEjcJn joFqRi">
                                <div class="sc-ePZHVD ePRQm">
                                    <label for="">Default Val : </label>
                                    <input id="defval" type="text">
                                </div>
                            </li>
                        </div>
                    </ul>
                </div>
                <div class="btmPanel">
                    <button style="background-color: #aadcff;" onclick="saveWid()">Save</button>
                    <button style="background-color: #ffaaaa;" onclick="cancelWid()">Cancel</button>
                </div>
            </div>
        </div>

        <div class="appInner" id="appInner" style="display:none;"></div>
        <div class="appInner mainappin" style="width: calc(100% - 230px)">
            <!-- TAB LINKS -->
            <div class="maindash">
                <div class="tab">
                    <button id="nTAB" class="tablinks newTab" data-cont="newTab">+</button>
                </div>
                <!-- CONTENT -->

            </div>
        </div>
    </div>
    </div>
    <div class="backDrop" @click="hideOpenedPanel" style="display: none;"></div>
    <div class="mainBackDrop" onclick="hideAll()" style="display: none;"></div>
    <script src="http://192.168.31.249/IOTINE_V2/mission-control/river_v1.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://code.jquery.com/jquery-1.11.1.js"></script>
    <script src="http://192.168.31.249/IOTINE_V2/mission-control/components.js" type="text/javascript"></script>
    <script>
        var socket = io()
        getUser();
        var crrntTab;
        var user;
        var app = window.location.pathname.split("/")[3];
        var type;

        async function getUser() {
            var username = window.location.pathname.split("/")[2];
            var xhttp = new XMLHttpRequest();
            xhttp.onreadystatechange = function () {
                if (this.readyState == 4 && this.status == 200) {
                    // Typical action to be performed when the document is ready:
                    user = xhttp.responseText;
                    socket.emit("JoinTheMess", user)
                }
            };
            xhttp.open("GET", "http://192.168.31.249:3002/user/" + username, true);
            await xhttp.send();
        }

        function toggleDis(elm) {
            var elm = document.querySelector(elm);
            if (elm.style.display == "none") {
                elm.style.display = "block"
            } else if (elm.style.display == "block") {
                elm.style.display = "none"
            }
        }

        var cancelWid = () => {
            $('.propane').toggle();
            var name = $("#name").val("");
            var device = $("#devProp").val("");
            var feed = $("#devFeeds").val("");
            var bgc = $("#bgc").val("");
            var brdc = $("#brdc").val("");
            var brdw = $("#brdw").val("");
            $(openedPropsOF).toggle()
            openedPropsOF = ''
        }

        var navLinks = document.getElementsByClassName("navlink");
        for (i = 0; i < navLinks.length; i++) {
            navLinks[i].addEventListener('click', function () {
                propertySelector(this.getAttribute("data-wtype"));
            })
        }

        function loadLink(lnk) {
            if (lnk == '/widgets') {
                $("#appInner").hide()
            } else {
                $('#appInner').load(lnk, function () {
                    $("#appInner").show()
                });
            }
        }

        var openedPropsOF;

        function propertySelector(typ) {
            type = typ;
            $("." + typ + "cnt").toggle()
            openedPropsOF = "." + typ + "cnt";
            $('.propane').toggle();
            getDevices();
            //createWidget([{name:"TEST", config:{}, type}])
        }

        async function loadFeeds(dev) {
            var feedLst = document.querySelector("#devFeeds");
            var xhttp = new XMLHttpRequest();
            xhttp.onreadystatechange = function () {
                if (this.readyState == 4 && this.status == 200) {
                    // Typical action to be performed when the document is ready:
                    var feeds = JSON.parse(xhttp.responseText)
                    if (feeds.length != 0) {
                        $("#devFeeds").empty();
                        feeds.forEach(feed => {
                            var opt = document.createElement('option')
                            opt.innerHTML = feed.name
                            opt.value = dev + "/" + feed.name;

                            feedLst.appendChild(opt)
                        })
                    } else {
                        $("#devFeeds").empty();
                        var opt = document.createElement('option')
                        opt.innerHTML = "No feeds found"
                        opt.value = 0;

                        feedLst.appendChild(opt)
                        return
                    }
                }
            };
            xhttp.open("GET", "http://192.168.31.249:3002/feeds/" + user + "/" + dev, true);
            await xhttp.send();
        }

        async function getDevices() {
            var devList = document.querySelector('#devProp')
            $("#devProp").empty().append('<option value="0">Select your device</option>');
            var xhttp = new XMLHttpRequest();
            xhttp.onreadystatechange = function () {
                if (this.readyState == 4 && this.status == 200) {
                    // Typical action to be performed when the document is ready:
                    var resdevice = JSON.parse(xhttp.responseText)
                    resdevice.forEach(device => {
                        var opt = document.createElement('option')
                        opt.innerHTML = device.template + " / " + device.dName
                        opt.value = device.deviceID;

                        devList.appendChild(opt)
                    })
                }
            };
            xhttp.open("GET", "http://192.168.31.249:3002/devices/" + user, true);
            await xhttp.send();
        }

        async function saveWid() {
            var name = $("#name").val();
            var device = $("#devProp").val();
            var feed = $("#devFeeds").val().split("/")[1];
            var bgc = $("#bgc").val();
            var brdc = $("#brdc").val();
            var brdw = $("#brdw").val();
            var minval = $("#minval").val();
            var maxval = $("#maxval").val();
            var defval = $("#defval").val();
            var schema;

            if (type == "chart") {
                schema = {
                    name: name,
                    feed: feed,
                    type: type,
                    datasets: [{
                        label: feed,
                        data: [],
                        backgroundColor: bgc,
                        borderColor: brdc,
                        borderWidth: brdw
                    }],
                    config: {
                        labels: [],
                        type: "line",
                        prevTime: '',
                        device: device,
                        tab: crrntTab
                    }
                }
            } else if (type == "btn") {
                schema = {
                    name: name,
                    feed: feed,
                    type: type,
                    config: {
                        bgcolor: "transparent",
                        borderColor: "cyan",
                        textColor: "red",
                        text: "ON",
                        changeText: "Off",
                        type: "ONOFF",
                        device: device,
                        tab: crrntTab
                    }
                }
            } else if (type == "map") {
                schema = {
                    name: name,
                    feed: feed,
                    type: "map",
                    config: {
                        device: device,
                        tab: crrntTab
                    }
                }
            } else if (type == "range") {
                schema = {
                    name: name,
                    feed: feed,
                    type: "range",
                    config: {
                        minval: minval,
                        maxval: maxval,
                        value: defval,
                        device: device,
                        tab: crrntTab
                    }
                }

            } else if (type == "log") {

            } else if (type == "vid") {

            } else if (type == "img") {

            } else if (type == "iframe") {

            }

            var xhttp = new XMLHttpRequest();

            xhttp.open("POST", "http://192.168.31.249:3002/newWidget/" + user + "/" + app, true);
            xhttp.setRequestHeader("Content-Type", "application/json");

            xhttp.onreadystatechange = function () {
                if (this.readyState == 4 && this.status == 200) {
                    // Typical action to be performed when the document is ready:
                    $(".propane").toggle();
                    makeWidget([schema])
                }
            };
            var data = JSON.stringify(schema);
            await xhttp.send(data);
        }

        function lChart(id, datas, config, widgetBdy, prev) {
            var chartContainer;
            if (prev == "") {
                chartContainer = document.createElement("canvas");
                chartContainer.className += "chart chartjs-render-monitor"
            } else {
                chartContainer = document.querySelector(".chart-" + prev)
            }

            chartContainer.className += " chart-" + id

            chartContainer.width = "325"
            chartContainer.height = "180"
            chartContainer.style.display = "block";



            widgetBdy.appendChild(chartContainer)
            var chart = new Chart(chartContainer.getContext('2d'), {
                type: config.type,
                data: {
                    labels: ["Delhi", "Mumbai", "Mexico City", "Shanghai", "Sao Paulo"],
                    datasets: [{
                        label: datas[0].label, // Name the series
                        data: [Math.floor(Math.random() * 10), Math.floor(Math.random() * 10), Math
                            .floor(Math.random() * 10), Math.floor(Math.random() * 10), Math.floor(
                                Math.random() * 10)
                        ],
                        borderColor: datas[0].borderColor, // Add custom color border (Line)
                        backgroundColor: datas[0]
                            .backgroundColor, // Add custom color background (Points and Fill)
                        borderWidth: datas[0].borderWidth // Specify bar border width
                    }]
                },
                options: {
                    scales: {
                        yAxes: [{
                            ticks: {
                                beginAtZero: true
                            }
                        }]
                    },
                    animation: true,
                    autoSkip: false,
                    legend: {
                        display: true
                    },
                    tooltips: {
                        enabled: true
                    }
                }
            });
            /*if(config.labels == ""){
                widgetBdy.innerHTML += "<p class='ndt'>not recieving any data</p>"
            }*/

        }

        function cButton(id, config, bdy) {
            var buttonCont = document.createElement("button")
            var btnId = "btn-" + id
            buttonCont.className += " wid-btn " + "btn-" + id

            bdy.className += " btn-wid"

            buttonCont.innerHTML = config.text
            buttonCont.style.backgroundColor = config.bgcolor
            buttonCont.style.borderColor = config.borderColor
            buttonCont.style.color = config.textColor

            bdy.appendChild(buttonCont)
        }

        function cMap(id, config, bdy) {
            var mapCont = document.createElement('img')
            mapCont.className += 'map-wid map-' + id
            mapCont.src =
                "https://media.nationalgeographic.org/assets/photos/333/793/fb1e4408-26be-4821-b667-8010401f20d6.jpg"

            bdy.className += " wid-map"

            bdy.appendChild(mapCont);
        }

        function cRange(feed, config, bdy) {
            var slider = document.createElement('input')
            slider.className += "slider range-" + feed
            slider.type = "range"
            slider.min = config.minval
            slider.max = config.maxval
            slider.value = config.value

            bdy.className += " wid-range"

            bdy.appendChild(slider)
        }

        function cLog(feed, config, bdy) {
            var logCont = document.createElement("code")
            logCont.className += " log-" + feed
            logCont.style.color = config.color + " !important"

            logCont.innerHTML += "CONNECTED TO " + config.device + "/" + feed + "<br>Waiting For Data...<br>"

            bdy.className += " wid-txt"

            bdy.appendChild(logCont)
        }

        function cImg(feed, config, bdy) {
            var imgCont = document.createElement("img")
            imgCont.src = config.src
            imgCont.height = "180"
            imgCont.width = "380"

            bdy.appendChild(imgCont)
        }

        function cVideo(feed, config, bdy) {
            var videoCont = document.createElement("video")
            videoCont.src = config.src
            videoCont.height = "180"
            videoCont.width = "380"

            bdy.appendChild(videoCont)
        }

        function cIFrame(feed, config, bdy) {
            var iframeCont = document.createElement("iframe")
            iframeCont.src = config.src
            iframeCont.height = "180"
            iframeCont.width = "380"
            iframeCont.gesture = "media"
            iframeCont.allow = "encrypted-media"

            bdy.appendChild(iframeCont)
        }

        async function makeWidget(widgets) {
            widgets.forEach(widget => {
                var widgetBdy = document.createElement('div')
                var head = document.createElement('h4');
                var latestData = document.createElement('p');

                latestData.className += " latData";
                head.className += " wid-head"
                widgetBdy.appendChild(head)
                widgetBdy.appendChild(latestData)
                head.innerHTML = widget.name;

                widgetBdy.className += 'widget ';
                document.querySelector('.maindash').appendChild(widgetBdy)

                document.querySelector("#" + widget.config.tab).appendChild(widgetBdy)

                widgetBdy.addEventListener('click', function () {
                    selectedWidget = this;
                    loadSchemaIntoPropane(widget)
                })

                if (type == "chart") {
                    var prev = ''
                    lChart(widget.feed, widget.datasets, widget.config, widgetBdy, prev)
                } else if (type == "btn") {
                    cButton(widget.feed, widget.config, widgetBdy)
                } else if (type == "map") {
                    cMap(widget.feed, widget.config, widgetBdy)
                } else if (type == "range") {
                    cRange(widget.feed, widget.config, widgetBdy)
                } else if (type == "log") {
                    cLog(widget.feed, widget.config, widgetBdy)
                } else if (type == "video") {
                    cVideo(widget.feed, widget.config, widgetBdy)
                } else if (type == "image") {
                    cImg(widget.feed, widget.config, widgetBdy)
                } else if (type == "iframe") {
                    cIFrame(widget.feed, widget.config, widgetBdy)
                }
            })

            var name = $("#name").val("");
            var device = $("#devProp").val("");
            var feed = $("#devFeeds").val("");
            var bgc = $("#bgc").val("");
            var brdc = $("#brdc").val("");
            var brdw = $("#brdw").val("");
            $(openedPropsOF).toggle()
            openedPropsOF = ''
        }
    </script>
    <script>
        getUser();
        var user;
        var app = window.location.pathname.split("/")[3];
        var selectedWidget;
        async function getUser() {
            var username = window.location.pathname.split("/")[2];
            var xhttp = new XMLHttpRequest();
            xhttp.onreadystatechange = function () {
                if (this.readyState == 4 && this.status == 200) {
                    // Typical action to be performed when the document is ready:
                    user = xhttp.responseText;
                    createTabs()
                }
            };
            xhttp.open("GET", "http://192.168.31.249:3002/user/" + username, true);
            await xhttp.send();
        }


        function getTabs() {
            return new Promise((resolve, reject) => {
                var xhttp = new XMLHttpRequest();
                xhttp.onreadystatechange = function () {
                    if (this.readyState == 4 && this.status == 200) {
                        // Typical action to be performed when the document is ready:
                        resolve(JSON.parse(xhttp.responseText))
                    }
                };
                xhttp.open("GET", "http://192.168.31.249:3002/tabs/" + user + "/" + app, true);
                xhttp.send();
            })
        }

        function getRandomColor() {
            var letters = '0123456789ABCDEF';
            var color = '#';
            for (var i = 0; i < 6; i++) {
                color += letters[Math.floor(Math.random() * 16)];
            }
            return color;
        }



        var dataa = []
        var labla = []
        var colors = []
        var feeds = []

        function lineChart(id, config, widgetBdy, prev) {
            var chartContainer;
            if (prev == "") {
                chartContainer = document.createElement("canvas");
                chartContainer.className += "chart chartjs-render-monitor"
            } else {
                chartContainer = document.querySelector(".chart-" + prev)
            }

            chartContainer.className += " chart-" + id

            chartContainer.width = "325"
            chartContainer.height = "180"
            chartContainer.style.display = "block";

            var ctx = chartContainer.getContext('2d')

            ctx.fillStyle = "#3880ff";
            ctx.font = '15px Arial';

            var textString = "DATA NOT AVAILABLE IN EDIT MODE",
                textWidth = ctx.measureText(textString).width;


            ctx.fillText(textString, (chartContainer.width / 2) - (textWidth / 2), 100);

            /*if(config.labels == ""){
                widgetBdy.innerHTML += "<p class='ndt'>not recieving any data</p>"
            }*/


            widgetBdy.appendChild(chartContainer)

            feeds.push(id)
        }

        function createGauge(id, config, widgetBdy) {
            var gaugeContainer = document.createElement("canvas");
            gaugeContainer.className += "chart"

            gaugeContainer.id = "gauge-" + id

            gaugeContainer.width = "325"
            gaugeContainer.height = "180"


            widgetBdy.appendChild(gaugeContainer)

            updateGauge(gaugeContainer.id, gaugeContainer.getContext('2d'), "hi", "retg54")

            feeds.push(id)
        }

        function createButton(id, config, bdy) {
            var buttonCont = document.createElement("button")
            var btnId = "btn-" + id
            buttonCont.className += " wid-btn " + "btn-" + id

            bdy.className += " btn-wid"

            buttonCont.innerHTML = config.text
            buttonCont.style.backgroundColor = config.bgcolor
            buttonCont.style.borderColor = config.borderColor
            buttonCont.style.color = config.textColor

            bdy.appendChild(buttonCont)
        }

        function createMap(id, config, bdy) {
            var mapCont = document.createElement('img')
            mapCont.className += 'map-wid map-' + id
            mapCont.src =
                "https://media.nationalgeographic.org/assets/photos/333/793/fb1e4408-26be-4821-b667-8010401f20d6.jpg"

            bdy.className += " wid-map"

            bdy.appendChild(mapCont);
        }

        function createRange(feed, config, bdy) {
            var slider = document.createElement('input')
            slider.className += "slider range-" + feed
            slider.type = "range"
            slider.min = config.minval
            slider.max = config.maxval
            slider.value = config.value

            bdy.className += " wid-range"

            bdy.appendChild(slider)
        }

        function createLog(feed, config, bdy) {
            var logCont = document.createElement("code")
            logCont.className += " log-" + feed
            logCont.style.color = config.color + " !important"

            logCont.innerHTML += "CONNECTED TO " + config.device + "/" + feed + "<br>Waiting For Data...<br>"

            bdy.className += " wid-txt"

            bdy.appendChild(logCont)
        }

        function createImg(feed, config, bdy) {
            var imgCont = document.createElement("img")
            imgCont.src = config.src
            imgCont.height = "180"
            imgCont.width = "380"

            bdy.appendChild(imgCont)
        }

        function createVideo(feed, config, bdy) {
            var videoCont = document.createElement("video")
            videoCont.src = config.src
            videoCont.height = "180"
            videoCont.width = "380"

            bdy.appendChild(videoCont)
        }

        function createIFrame(feed, config, bdy) {
            var iframeCont = document.createElement("iframe")
            iframeCont.src = config.src
            iframeCont.height = "180"
            iframeCont.width = "380"
            iframeCont.gesture = "media"
            iframeCont.allow = "encrypted-media"

            bdy.appendChild(iframeCont)
        }
        var widgets;
        async function createWidget() {
            var xhttp = new XMLHttpRequest();
            xhttp.onreadystatechange = function () {
                if (this.readyState == 4 && this.status == 200) {
                    // Typical action to be performed when the document is ready:
                    widgets = JSON.parse(xhttp.responseText)
                    widgets.forEach(widget => {
                        var widgetBdy = document.createElement('div')
                        var head = document.createElement('h4');
                        var latestData = document.createElement('p');

                        latestData.className += " latData";
                        head.className += " wid-head"
                        widgetBdy.appendChild(head)
                        widgetBdy.appendChild(latestData)
                        head.innerHTML = widget.name;

                        widgetBdy.className += 'widget';

                        widgetBdy.addEventListener('click', function () {
                            selectedWidget = this;
                            loadSchemaIntoPropane(widget)
                        })

                        document.querySelector("#" + widget.config.tab).appendChild(widgetBdy)

                        if (widget.type == "chart") {
                            var prev = ''
                            lineChart(widget.feed, widget.config, widgetBdy, prev)
                        } else if (widget.type == "button") {
                            createButton(widget.feed, widget.config, widgetBdy)
                        } else if (widget.type == "map") {
                            createMap(widget.feed, widget.config, widgetBdy)
                        } else if (widget.type == "range") {
                            createRange(widget.feed, widget.config, widgetBdy)
                        } else if (widget.type == "log") {
                            createLog(widget.feed, widget.config, widgetBdy)
                        } else if (widget.type == "video") {
                            createVideo(widget.feed, widget.config, widgetBdy)
                        } else if (widget.type == "image") {
                            createImg(widget.feed, widget.config, widgetBdy)
                        } else if (widget.type == "iframe") {
                            createIFrame(widget.feed, widget.config, widgetBdy)
                        }

                    })
                }
            };
            xhttp.open("GET", "http://192.168.31.249:3002/widgets/" + user + "/" + app, true);
            await xhttp.send();
        }

        function getWidget(feed) {
            var obj = [];
            for (i = 0; i < widgets.length; i++) {
                if (widgets[i].feed == feed) {
                    obj.push(widgets[i])

                }
            }
            return obj
        }

        function openTab(evt, id) {
            var i, tabcontent, tablinks;

            tabcontent = document.getElementsByClassName("tabcontent");

            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
            }

            tablinks = document.getElementsByClassName("tablinks");
            for (i = 0; i < tablinks.length; i++) {
                tablinks[i].className = tablinks[i].className.replace(" active", "");
            }

            document.querySelector("#" + id).style.display = "block";
            evt.currentTarget.className += " active";

        }

        function addClicks() {
            var tabLink = document.getElementsByClassName("tablinks");
            for (i = 0; i < tabLink.length; i++) {
                tabLink[i].addEventListener('click', function () {
                    crrntTab = this.getAttribute("data-cont")
                    if (crrntTab != "newTab") {
                        openTab(event, this.classList[1])
                    } else {
                        createNewTab(prompt("name"))
                    }
                })
            }
        }

        function createNewTab(name) {
            var xhttp = new XMLHttpRequest();
            xhttp.onreadystatechange = function () {
                if (this.readyState == 4 && this.status == 200) {
                    // Typical action to be performed when the document is ready:
                    $(".maindash").empty()
                    var tabsHolder = document.createElement("div")
                    tabsHolder.className = "tab";
                    $(tabsHolder).html(' <button id="nTAB" class="tablinks newTab" data-cont="newTab">+</button>')
                    $(".maindash").append(tabsHolder)
                    createTabs()
                }
            };
            xhttp.open("POST", "http://192.168.31.249:3002/newTab/" + user + "/" + app + "/" + name, true);
            xhttp.send();
        }

        function createTabs() {
            getTabs().then(tabs => {
                for (var i = 0; i < tabs.length; i++) {
                    var tabbar = document.querySelector("#nTAB")
                    var tabLink = document.createElement("button")
                    var tabCont = document.createElement("div")

                    tabLink.className += "tablinks"
                    tabCont.className += "tabcontent"


                    var tab = tabs[i]
                    tabLink.innerHTML = tab.name


                    tabLink.className += " " + tab.tabId

                    tabCont.id = tab.tabId
                    tabLink.setAttribute("data-cont", tab.tabId)

                    $("#nTAB").before(tabLink)

                    var dash = document.querySelector(".maindash")
                    dash.appendChild(tabCont)


                    if (i == 0) {
                        tabCont.style.display = "block"
                        tabLink.className += " active"
                        crrntTab = tab.tabId
                    }
                }

                addClicks()
                createWidget()
            })
        }

        function updateChart(id, ctx, msg, feed) {
            var allElms = $(".chart-" + feed).show()
            for (i = 0; i < allElms.length; i++) {
                var widgets = getWidget(feed)
                for (j = 0; j < widgets.length; j++) {
                    widget = widgets[j]
                    ctx = allElms[j].getContext('2d')
                    //console.log(/\d/.test(msg.value))
                    var config = widgets[j].config

                    widgets[j].datasets[0].data.push(msg.value)

                    config.labels.push(msg.time)

                    var chart = new Chart(ctx, {
                        type: config.type,
                        data: {
                            labels: config.labels,
                            datasets: widgets[j].datasets
                        },
                        options: {
                            scales: {
                                yAxes: [{
                                    ticks: {
                                        beginAtZero: true
                                    }
                                }]
                            },
                            animation: true,
                            autoSkip: false,
                            legend: {
                                display: true
                            },
                            tooltips: {
                                enabled: true
                            }
                        }
                    });

                    if (widgets[j].datasets[0].data.length >= 5) {
                        widgets[j].datasets[0].data.shift()
                        config.labels.shift()
                        //$(".ndt").remove()
                        chart.update()
                    } else {
                        //$(".ndt").remove()
                        chart.update()
                    }
                }
            }

        }
        socket.on('subscribe', (feed, msg, unit) => {

            feeds.forEach(mfeed => {
                if (mfeed == feed) {
                    var chart = document.querySelector(".chart-" + feed)
                    var latestData = chart.previousSibling
                    latestData.innerHTML = msg.value + " " + unit[0].unit
                    var ctx = chart.getContext("2d")
                    updateChart("chart-" + feed, ctx, msg, feed)
                } else {
                    return
                }
            })
        });

        function loadSchemaIntoPropane(schema){
            var name = $("#name").val(schema.name);
            var device = $("#devProp").val(schema.config.device);
            var feed = $("#devFeeds").val(schema.config.name).split("/")[1];
            var bgc = $("#bgc").val(schema.datasets[0].backgroundColor);
            var brdc = $("#brdc").val(schema.datasets[0].borderColor);
            var brdw = $("#brdw").val(schema.datasets[0].borderWidth);

            propertySelector(schema.type)
        }
    </script>
</body>

</html>